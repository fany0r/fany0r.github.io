<!DOCTYPE html><html lang="en" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/favicons/tool-logo.png"><link rel="icon" href="/favicons/favicon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="msvalidate.01" content="6CDECB7628FCAB6B2809D0BB2021D458"><meta name="google-site-verification" content="-aHgnC4GpgdSy24VC2beoxvaFnCzmcyt_Z8p2ZnILy0"><meta name="theme-color" content="#2f4154"><meta name="author" content="guosec"><meta name="keywords" content="guosec,学习笔记,blog,漏洞复现"><meta name="description" content="CS 本身 修改特征：watermark水印、Stager Url算法(checksum8)、Beacon Config密钥。 0x01 反编译JAR包 1、用IEDA中的 java-decompiler.jar(需要JDK 11+才可运行)来进行反编译CS。 jar包位于：plugins\java-decompiler\lib Windows 下，即：C:\Program Files\JetBr"><meta property="og:type" content="article"><meta property="og:title" content="修改Cobalt Strike小记"><meta property="og:url" content="https://guosec.online/posts/324e2628.html"><meta property="og:site_name" content="InfoSec&#39;s Blog"><meta property="og:description" content="CS 本身 修改特征：watermark水印、Stager Url算法(checksum8)、Beacon Config密钥。 0x01 反编译JAR包 1、用IEDA中的 java-decompiler.jar(需要JDK 11+才可运行)来进行反编译CS。 jar包位于：plugins\java-decompiler\lib Windows 下，即：C:\Program Files\JetBr"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://s1.ax1x.com/2022/09/16/vz5ZWT.png"><meta property="article:published_time" content="2022-04-14T17:51:37.000Z"><meta property="article:modified_time" content="2022-09-28T07:02:52.791Z"><meta property="article:author" content="guosec"><meta property="article:tag" content="guosec,学习笔记,blog,漏洞复现"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://s1.ax1x.com/2022/09/16/vz5ZWT.png"><title>修改Cobalt Strike小记 - InfoSec&#39;s Blog</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/macpanel.css"><link rel="stylesheet" href="/css/hbe.style.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"guosec.online",root:"/",version:"1.9.5",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:null,google:{measurement_id:null},tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 7.0.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>InfoSec&#39;s Blog</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> <span>Home</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> <span>Archives</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> <span>Categories</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> <span>Tags</span></a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> <span>Links</span></a></li><li class="nav-item"><a class="nav-link" href="https://guosec.online/tools-pages/"><i class="iconfont icon-briefcase"></i> <span>Tools</span></a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> <span>About</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(https://s1.ax1x.com/2022/09/16/vz5ZWT.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="修改Cobalt Strike小记"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2022-04-15 01:51" pubdate>April 15, 2022 am</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 12k words </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 12 mins</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">修改Cobalt Strike小记</h1><p class="note note-info">Last updated on a year ago</p><div class="markdown-body"><h2 id="CS-本身">CS 本身</h2><p>修改特征：watermark水印、Stager Url算法(checksum8)、Beacon Config密钥。</p><h3 id="0x01-反编译JAR包">0x01 反编译JAR包</h3><p>1、用IEDA中的 java-decompiler.jar(需要JDK 11+才可运行)来进行反编译CS。<br>jar包位于：plugins\java-decompiler\lib<br>Windows 下，即：C:\Program Files\JetBrains\IntelliJ IDEA 2020.3.2\plugins\java-decompiler\lib</p><p>2、原版CS 4.4 jar<br><a target="_blank" rel="noopener" href="https://www.ddosi.org/cobaltstrike-4-4-csagent/">https://www.ddosi.org/cobaltstrike-4-4-csagent/</a><br><a target="_blank" rel="noopener" href="https://github.com/trewisscotch/CobaltStr4.4/">https://github.com/trewisscotch/CobaltStr4.4/</a></p><p>目录结构：</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs basic">D:\JAVAPROJECT\CS-CMPILATION<br>│  java-decompiler.jar<br>├─cs_bin # 原cs jar 目录<br>│      cobaltstrike.jar<br>└─cs_src # 反编译输出目录<br></code></pre></td></tr></table></figure><p>运行反编译命令</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs basic">java -cp java-decompiler.jar org.jetbrains.java.decompiler.main.decompiler.ConsoleDecompiler -dsg=true .\cs_bin\cobaltstrike.jar .\cs_src<br></code></pre></td></tr></table></figure><p>反编译完成后得到cs的java源码(cs_src\cobaltstrike.jar 是个zip需要解压。)</p><h3 id="0x02-环境搭建">0x02 环境搭建</h3><p>主要参考：</p><p><a target="_blank" rel="noopener" href="https://pingmaoer.github.io/2020/06/24/CobaltStrike%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87/">https://pingmaoer.github.io/2020/06/24/CobaltStrike二次开发环境准备/</a></p><h4 id="新建-IDEA-项目">新建 IDEA 项目</h4><p>新建项目JDK选 1.8 ，选择低版本jdk是为了向上兼容。<br>项目创建后，在根目录新建俩文件夹：<code>decompiled_src</code> 和 <code>lib</code> 。decompiled_src 放反编译得到的所有源码文件，lib放原版cs jar包。</p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036219625-3f45166c-41da-4243-b959-f06ccda0f247.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><h4 id="设置项目结构">设置项目结构</h4><p>IDEA左上角 文件 &gt; 项目结构 &gt; 模块 &gt; 依赖 添加原版 cobaltstrike.jar</p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036220147-59841a91-f4d9-4f14-95f4-62a99b3684d8.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><p><br>打勾启用</p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036220578-b8f9b0aa-a386-4abf-aeef-88bdda384f32.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><p><br>设置入口 ，项目结构 &gt; 工件 &gt; JAR &gt; 来自具有依赖项的模块…</p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036221088-1342a390-8235-4dbb-8aa5-134d4610b601.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><p><br>Main-Class ：aggressor.Aggressor</p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036221513-27dc9b4e-26ab-41bc-8e7b-4a6cfb484d0c.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><p><br>测试：src下新建软件包：aggressor，然后转到反编译完的aggressor中Aggressor.java，按F5，或者右键 重构 &gt; 复制文件 至 aggressor ，<strong>后续修改其他模块代码也是如此操作</strong>。</p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036221900-7827e08a-6103-426e-a7bd-56cc41c8fe7c.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><p><br>编辑 Aggressor.java 添加弹窗测试代码如：<code>JOptionPane.showMessageDialog(null,&quot;hello CS!!!&quot;);</code></p><p>生成jar包，菜单，构建 &gt; 构建工件，会在 out/artifacts/xx/ 下生成jar包。</p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036222300-a423bc4e-4166-486e-b7f7-6da149d75e09.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><h4 id="添加运行-调试配置">添加运行/调试配置</h4><p>jar路径：上面生成的jar包。虚拟机选项写 [-XX:+AggressiveHeap -XX:+UseParallelGC]</p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036222608-7a2431af-e1a1-4dad-84fa-696733282be6.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><p><br>运行，报错了，找不到授权文件…</p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036223182-7832bdef-30af-4fda-806c-cc8b7dc0d58c.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><p><br>下载 <a target="_blank" rel="noopener" href="https://github.com/Twi1ight/CSAgent">https://github.com/Twi1ight/CSAgent</a> 解压复制到 out/artifacts/xx/ 下，跟构建出来的jar同级。</p><p>编辑 配置选项，追加虚拟机选项：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">-javaagent:D:\JavaProject\ChangeCS\out\artifacts\ChangeCS_jar\CSAgent.jar=5e98194a01c6b48fa582a6a9fcbb92d6 -Duser.language=en<br></code></pre></td></tr></table></figure><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036223620-203873cd-e1da-4e79-81a1-85a562de45c1.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><p><br>不出意外运行后就结束退出了。。。</p><p>这是因为触发了暗桩 ：<a target="_blank" rel="noopener" href="https://github.com/lovechoudoufu/cobaltstrike4.4_cdf#%E5%8E%BB%E9%99%A4%E6%9A%97%E6%A1%A9">去除暗桩</a></p><h3 id="0x03-去除暗桩">0x03 去除暗桩</h3><p>通过IDEA复制 beacon/BeaconData.java 到项目src下，将shouldPad方法的值改为false</p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036224310-258aec27-6ddb-4f13-95e8-ea902e61ef3c.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><p><br>注释 common/Helper.java 31~51行。</p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036224687-58a14ed8-48a0-495b-8019-a7065a9407e2.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><p><br>common/Starter.java 11~13行。</p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036225363-9b7b1890-635d-4f9c-86c2-472610a7fc50.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><p><br>common/Starter2.java 12~14行。</p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036225743-1e8df97d-4e78-4747-8e24-570856039133.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><p><br>重新构建，即可正常运行，弹出hello CS，确定后出现CS登录页面。</p><h3 id="0x04-去除水印">0x04 去除水印</h3><p>修改 common/ListenerConfig.java ，注释掉49行，添加 <code>var3.append((char)CommonUtils.rand(255));</code><br></p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036226432-60d545e6-3a0e-4f02-8992-15264d818d02.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><h3 id="0x05-修改stager">0x05 修改stager</h3><p>checksum8 脚本</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EchoSum</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">checksum8</span><span class="hljs-params">(String text)</span> &#123;<br>        <span class="hljs-keyword">if</span> (text.length() &lt; <span class="hljs-number">4</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0L</span>;<br>        &#125;<br>        text = text.replace(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>        <span class="hljs-type">long</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0L</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; x &lt; text.length(); x++) &#123;<br>            sum += text.charAt(x);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> sum;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;x86: &quot;</span> + checksum8(<span class="hljs-string">&quot;f796xxx.js&quot;</span>)); <span class="hljs-comment">// 可自行修改</span><br>        System.out.println(<span class="hljs-string">&quot;x64: &quot;</span> + checksum8(<span class="hljs-string">&quot;dd83xxx.js&quot;</span>)); <span class="hljs-comment">// 可自行修改</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="https://www.tutorialspoint.com/compile_java_online.php">https://www.tutorialspoint.com/compile_java_online.php</a></p><p>运行得到：1270、1396</p><p>修改 cloudstrike/webserver.java 175、179、183行，替换，以及删除183行的 &amp;&amp; uri.matches(“/[A-Za-z0-9]{4}”)</p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036226859-60ebdf43-b89e-4e87-862b-e1fba03bdd43.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><p><br>添加个判断，防止不规范路径泄露stage以及修复log4j2漏洞：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (!uri.startsWith(<span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.processResponse(uri, method, header, param, <span class="hljs-literal">false</span>, (WebService)<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-string">&quot;400 Bad Request&quot;</span>, <span class="hljs-string">&quot;text/plain&quot;</span>, <span class="hljs-string">&quot;&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036227854-66f4db9f-e5d9-465d-aeac-ee9440c5b948.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><p><br>修改 common/CommonUtils.java</p><p>1385行 return var2.toString(); 为 return “f796xxx.js;”, 1400行 return var1; 为 return dd83xxx.js;</p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036228971-7d50708d-7e2a-4634-b1d1-b980d36e4a78.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><p><br>重新构建jar包会报错，删除报错变量：int len$;、String[] 、WebService service; 即可。</p><h3 id="0x06-修改服务登录接口">0x06 修改服务登录接口</h3><p>修改 teamserver登录接口，防爆破。</p><p>在当前项目src新建软件包ssl ，然后 通过IDEA 复制反编译出来的 ssl/SecureServerSocket.java 和 ssl/SecureSocket.java 到当前项目src/ssl下，修改 48879 为其他数字值。</p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036229733-419ab755-eb94-4df4-a343-40acfe0cce74.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><h3 id="0x07-解密sleeve资源">0x07 解密sleeve资源</h3><p>用jas502大佬的 <a target="_blank" rel="noopener" href="https://github.com/jas502n/cs_file_decrypt">cs_file_decrypt</a> 解密 sleeve下的dll资源文件。</p><p>需要注意的是 CrackSleeve.java 密钥是其他版本CS的，需要修改为 当前版本的。</p><p><a target="_blank" rel="noopener" href="https://github.com/lovechoudoufu/cobaltstrike4.4_cdf#%E7%A0%B4%E8%A7%A3%E6%96%B9%E5%BC%8F">cobaltstrike4.4破解方式</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">94</span>, -<span class="hljs-number">104</span>, <span class="hljs-number">25</span>, <span class="hljs-number">74</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">58</span>, -<span class="hljs-number">76</span>, -<span class="hljs-number">113</span>, -<span class="hljs-number">91</span>, -<span class="hljs-number">126</span>, -<span class="hljs-number">90</span>, -<span class="hljs-number">87</span>, -<span class="hljs-number">4</span>, -<span class="hljs-number">69</span>, -<span class="hljs-number">110</span>, -<span class="hljs-number">42</span><br></code></pre></td></tr></table></figure><p>完整 CrackSleeve.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> common.*;<br><span class="hljs-keyword">import</span> dns.SleeveSecurity;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.util.Enumeration;<br><span class="hljs-keyword">import</span> java.util.jar.JarEntry;<br><span class="hljs-keyword">import</span> java.util.jar.JarFile;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CrackSleeve</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] OriginKey = &#123;<span class="hljs-number">94</span>, -<span class="hljs-number">104</span>, <span class="hljs-number">25</span>, <span class="hljs-number">74</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">58</span>, -<span class="hljs-number">76</span>, -<span class="hljs-number">113</span>, -<span class="hljs-number">91</span>, -<span class="hljs-number">126</span>, -<span class="hljs-number">90</span>, -<span class="hljs-number">87</span>, -<span class="hljs-number">4</span>, -<span class="hljs-number">69</span>, -<span class="hljs-number">110</span>, -<span class="hljs-number">42</span>&#125;;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] CustomizeKey = <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">DecDir</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;cs44Resource/Decode/sleeve&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">EncDir</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;cs44Resource/Encode/sleeve&quot;</span>;<br><br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">bytesToHex</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] data)</span> &#123;<br>        <span class="hljs-type">char</span>[] hex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[<span class="hljs-number">32</span>];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; i++) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">di</span> <span class="hljs-operator">=</span> data[i];<br>            hex[i &lt;&lt; <span class="hljs-number">1</span>] = Character.forDigit((di &gt;&gt; <span class="hljs-number">4</span>) &amp; <span class="hljs-number">15</span>, <span class="hljs-number">16</span>);<br>            hex[(i &lt;&lt; <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>] = Character.forDigit(di &amp; <span class="hljs-number">15</span>, <span class="hljs-number">16</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(hex);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] hex2bytes(String var0) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">var1</span> <span class="hljs-operator">=</span> var0.length();<br>        <span class="hljs-type">byte</span>[] var2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[var1 / <span class="hljs-number">2</span>];<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">var3</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var3 &lt; var1; var3 += <span class="hljs-number">2</span>) &#123;<br>            var2[var3 / <span class="hljs-number">2</span>] = (<span class="hljs-type">byte</span>) ((Character.digit(var0.charAt(var3), <span class="hljs-number">16</span>) &lt;&lt; <span class="hljs-number">4</span>) + Character.digit(var0.charAt(var3 + <span class="hljs-number">1</span>), <span class="hljs-number">16</span>));<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> var2;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] Generate_Key() &#123;<br>        java.security.<span class="hljs-type">SecureRandom</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.security.SecureRandom();<br>        <span class="hljs-type">byte</span>[] PrivateBytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">16</span>];<br>        random.nextBytes(PrivateBytes);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">Random_Keys</span> <span class="hljs-operator">=</span> java.util.Arrays.toString(PrivateBytes);<br>        System.out.println(<span class="hljs-string">&quot;[-] Example: \n[*] Random_Keys= &quot;</span> + Random_Keys);<br>        <span class="hljs-keyword">return</span> PrivateBytes;<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-keyword">if</span> (args.length == <span class="hljs-number">0</span> || args[<span class="hljs-number">0</span>].equals(<span class="hljs-string">&quot;-h&quot;</span>) || args[<span class="hljs-number">0</span>].equals(<span class="hljs-string">&quot;--help&quot;</span>)) &#123;<br>            System.out.println(<span class="hljs-string">&quot;UseAge: CrackSleeve OPTION [key]&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;Options:&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;\tdecode\t\tDecode sleeve files&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;\tencode\t\tEncode sleeve files&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;\tkey\t\tCustomize key string for encode sleeve files&quot;</span>);<br>            System.exit(<span class="hljs-number">0</span>);<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">option</span> <span class="hljs-operator">=</span> args[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span> (option.toLowerCase().equals(<span class="hljs-string">&quot;encode&quot;</span>)) &#123;<br>            <span class="hljs-keyword">if</span> (args.length &lt;= <span class="hljs-number">1</span>) &#123;<br>                System.out.println(<span class="hljs-string">&quot;[-] Please enter key.&quot;</span>);<br>                <span class="hljs-type">byte</span>[] Customize_key = Generate_Key();<br>                System.out.println(<span class="hljs-string">&quot;[*] Random_Keys Hash =&gt;&gt; &quot;</span> + bytesToHex(Customize_key));<br>                System.out.printf(<span class="hljs-string">&quot;[*] $ java -cp cobaltstrike.jar:. CrackSleeve encode %s \n&quot;</span>, bytesToHex(Customize_key) +<span class="hljs-string">&quot;\n&quot;</span>);<br>                System.exit(<span class="hljs-number">0</span>);<br>            &#125;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">CustomizeKeyStr</span> <span class="hljs-operator">=</span> args[<span class="hljs-number">1</span>];<br>            <span class="hljs-keyword">if</span> (CustomizeKeyStr.length() &lt; <span class="hljs-number">16</span>) &#123;<br>                System.out.println(<span class="hljs-string">&quot;[-] key length must be 16.&quot;</span>);<br>                System.exit(<span class="hljs-number">0</span>);<br>            &#125;<br>            System.out.println(<span class="hljs-string">&quot;Init Key: &quot;</span> + CustomizeKeyStr.substring(<span class="hljs-number">0</span>, <span class="hljs-number">32</span>));<br><span class="hljs-comment">//            CustomizeKey = CustomizeKeyStr.substring(0,16).getBytes();</span><br>            CustomizeKey = hex2bytes(CustomizeKeyStr.substring(<span class="hljs-number">0</span>, <span class="hljs-number">32</span>));<br>        &#125;<br><br><br>        <span class="hljs-type">CrackSleeve</span> <span class="hljs-variable">Cracker</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CrackSleeve</span>();<br>        <span class="hljs-comment">// 使用正版key初始化SleeveSecurity中的key</span><br>        <span class="hljs-keyword">if</span> (option.equals(<span class="hljs-string">&quot;decode&quot;</span>)) &#123;<br>            CrackSleevedResource.Setup(OriginKey);<br>            Cracker.DecodeFile();<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (option.equals(<span class="hljs-string">&quot;encode&quot;</span>)) &#123;<br>            CrackSleevedResource.Setup(CustomizeKey);<br>            Cracker.EncodeFile();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">DecodeFile</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// 文件保存目录</span><br>        <span class="hljs-type">File</span> <span class="hljs-variable">saveDir</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-built_in">this</span>.DecDir);<br>        <span class="hljs-keyword">if</span> (!saveDir.isDirectory()) &#123;<br>            saveDir.mkdirs();<br>        &#125;<br><br>        <span class="hljs-comment">// 获取jar文件中sleeve文件夹下的文件列表</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getClass().getClassLoader().getResource(<span class="hljs-string">&quot;sleeve&quot;</span>).getPath();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">jarPath</span> <span class="hljs-operator">=</span> path.substring(<span class="hljs-number">5</span>, path.indexOf(<span class="hljs-string">&quot;!/&quot;</span>));<br>            Enumeration&lt;JarEntry&gt; jarEnum = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JarFile</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(jarPath)).entries();<br>            <span class="hljs-keyword">while</span> (jarEnum.hasMoreElements()) &#123;<br>                <span class="hljs-type">JarEntry</span> <span class="hljs-variable">Element</span> <span class="hljs-operator">=</span> jarEnum.nextElement();<br>                <span class="hljs-type">String</span> <span class="hljs-variable">FileName</span> <span class="hljs-operator">=</span> Element.getName();<br>                <span class="hljs-keyword">if</span> (FileName.indexOf(<span class="hljs-string">&quot;sleeve&quot;</span>) &gt;= <span class="hljs-number">0</span> &amp;&amp; !FileName.equals(<span class="hljs-string">&quot;sleeve/&quot;</span>)) &#123;<br>                    System.out.print(<span class="hljs-string">&quot;[+] Decoding &quot;</span> + FileName + <span class="hljs-string">&quot;......&quot;</span>);<br>                    <span class="hljs-type">byte</span>[] decBytes = CrackSleevedResource.DecodeResource(FileName);<br>                    <span class="hljs-keyword">if</span> (decBytes.length &gt; <span class="hljs-number">0</span>) &#123;<br>                        System.out.println(<span class="hljs-string">&quot;Done.&quot;</span>);<br>                        CommonUtils.writeToFile(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(saveDir, <span class="hljs-string">&quot;../&quot;</span> + FileName), decBytes);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        System.out.println(<span class="hljs-string">&quot;Fail.&quot;</span>);<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">EncodeFile</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 文件保存目录</span><br>        <span class="hljs-type">File</span> <span class="hljs-variable">saveDir</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-built_in">this</span>.EncDir);<br>        <span class="hljs-keyword">if</span> (!saveDir.isDirectory()) &#123;<br>            saveDir.mkdirs();<br>        &#125;<br><br>        <span class="hljs-comment">// 获取解密文件列表</span><br>        <span class="hljs-type">File</span> <span class="hljs-variable">decDir</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-built_in">this</span>.DecDir);<br>        File[] decFiles = decDir.listFiles();<br>        <span class="hljs-keyword">if</span> (decFiles.length == <span class="hljs-number">0</span>) &#123;<br>            System.out.println(<span class="hljs-string">&quot;[-] There&#x27;s no file to encode, please decode first.&quot;</span>);<br>            System.exit(<span class="hljs-number">0</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (File file : decFiles) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> decDir.getPath() + <span class="hljs-string">&quot;/&quot;</span> + file.getName();<br>            System.out.print(<span class="hljs-string">&quot;[+] Encoding &quot;</span> + file.getName() + <span class="hljs-string">&quot;......&quot;</span>);<br>            <span class="hljs-type">byte</span>[] encBytes = CrackSleevedResource.EncodeResource(filename);<br>            <span class="hljs-keyword">if</span> (encBytes.length &gt; <span class="hljs-number">0</span>) &#123;<br>                System.out.println(<span class="hljs-string">&quot;Done.&quot;</span>);<br>                CommonUtils.writeToFile(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(saveDir, file.getName()), encBytes);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                System.out.println(<span class="hljs-string">&quot;Fail.&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">CrackSleevedResource</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> CrackSleevedResource singleton;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">SleeveSecurity</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SleeveSecurity</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Setup</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] paramArrayOfbyte)</span> &#123;<br>        singleton = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CrackSleevedResource</span>(paramArrayOfbyte);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] DecodeResource(String paramString) &#123;<br>        <span class="hljs-keyword">return</span> singleton._DecodeResource(paramString);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] EncodeResource(String paramString) &#123;<br>        <span class="hljs-keyword">return</span> singleton._EncodeResource(paramString);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">CrackSleevedResource</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] paramArrayOfbyte)</span> &#123;<br>        <span class="hljs-built_in">this</span>.data.registerKey(paramArrayOfbyte);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] _DecodeResource(String paramString) &#123;<br>        <span class="hljs-type">byte</span>[] arrayOfByte1 = CommonUtils.readResource(paramString);<br>        <span class="hljs-keyword">if</span> (arrayOfByte1.length &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">l</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.data.decrypt(arrayOfByte1);<br>        &#125;<br>        <span class="hljs-type">byte</span>[] arrayOfByte2 = CommonUtils.readResource(paramString);<br>        <span class="hljs-keyword">if</span> (arrayOfByte2.length == <span class="hljs-number">0</span>) &#123;<br>            CommonUtils.print_error(<span class="hljs-string">&quot;Could not find sleeved resource: &quot;</span> + paramString + <span class="hljs-string">&quot; [ERROR]&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            CommonUtils.print_stat(<span class="hljs-string">&quot;Used internal resource: &quot;</span> + paramString);<br>        &#125;<br>        <span class="hljs-keyword">return</span> arrayOfByte2;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] _EncodeResource(String paramString) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">File</span> <span class="hljs-variable">fileResource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(paramString);<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">fileStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(fileResource);<br>            <span class="hljs-keyword">if</span> (fileStream != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">byte</span>[] fileBytes = CommonUtils.readAll(fileStream);<br>                <span class="hljs-keyword">if</span> (fileBytes.length &gt; <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-type">byte</span>[] fileEncBytes = <span class="hljs-built_in">this</span>.data.encrypt(fileBytes);<br>                    <span class="hljs-keyword">return</span> fileEncBytes;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (FileNotFoundException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>CrackSleeve.java 与原版cs jar放同一目录，执行如下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">javac -encoding UTF-8 -classpath cobaltstrike.jar CrackSleeve.java<br>java -classpath cobaltstrike.jar;./ CrackSleeve decode<br></code></pre></td></tr></table></figure><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036230182-57a270c6-f2b3-4609-94d6-abe6dfd4648c.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><h3 id="0x08-修改默认密钥">0x08 修改默认密钥</h3><h4 id="BeaconPayload">BeaconPayload</h4><p>修改 beacon/BeaconPayload.java 方法 beacon_obfuscate() 中的 46，即 0x2E为其他数字十六进制形式。</p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036230630-c4a47762-32db-40ac-be5e-7fbe37368d92.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><h4 id="修改DLL密钥">修改DLL密钥</h4><p>需要修改的dll文件：</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs basic">beacon.dll<br>beacon.x64.dll<br>dnsb.dll<br>dnsb.x64.dll<br>pivot.dll<br>pivot.x64.dll<br>extc2.dll<br>extc2.x64.dll<br></code></pre></td></tr></table></figure><p>IDA分别打开上述文件，搜索0x2e是否为异或行为(xor)，出现则Patch，Alt+I 全局搜索0x2e 进行替换为 BeaconPayload.java 中新的值。注意，32位的dll用32位IDA，64反之一样。</p><p>然后，工具栏 Edit–Patch Program–Change byte</p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036231014-7d7ecb54-311a-49d7-81e7-ad6af3f54684.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><p><br>修改之后 点击 Edit–Patch Program—Apply Patches to input file ，关闭文件，继续修改下一dll文件个。</p><h3 id="0x09-去除BeaconEye特征">0x09 去除BeaconEye特征</h3><p>用32位IDA打开 beacon.dll，点Hex View-1视图， 按G 跳转到地址：1000A0B9 ，F2或者右键Edit…</p><p><code>6A 00</code> 修改为<code>6A 08</code>，00可修改其他值。</p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036231667-1824ac61-f094-4e9d-b18b-e957a3f7e77a.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><p><br>修改之后 点击 Edit–Patch Program–Apply Patches to input file ，关闭文件。</p><p>用64位IDA 打开 beacon.x64.dll，按G跳转到地址：<code>000000018001879B</code>，右键 Text View</p><p>然后IDA左上角 Edit----Patch Program—Assemble 修改指令 xor edx, edx 为 mov edx, esi</p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036232075-2b139d5a-8202-4890-afbd-fc4409208bd4.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><p><br>Edit–Patch Program–Apply Patches to input file</p><h4 id="重新加密DLL">重新加密DLL</h4><p>修改完dll后重新加密。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">java -classpath cobaltstrike.jar;./ CrackSleeve encode 5e98194a01c6b48fa582a6a9fcbb92d6<br></code></pre></td></tr></table></figure><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036232679-700a2eed-db01-41f4-8c99-de316b7e55a2.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><p><br><code>cs44Resource\Encode\sleeve</code> 下 会生成重新加密后的DLL。</p><h4 id="重新构建CS">重新构建CS</h4><p>CS项目下新建文件夹 resources，并把其设置为资源类型。并且把 cs44Resource\Encode\sleeve 整个文件夹复制进去：</p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036233130-7972f000-c41d-48eb-8ffc-5cc36e001aaf.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><p><br>把CS原来 MANIFEST.MF 中的内容全部复制到项目 src\META0INF\MANIFEST.MF，替换。</p><p>构建-&gt;构建工件-&gt;重新构建，生成新cs jar包。</p><p>EvilEye、BeaconEye检测结果如下：</p><p>未修改前</p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036233785-b1918cb2-d7d4-4d1a-bb22-a917556dcd84.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><p><br>修改后</p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036234225-b4847c77-68f0-47fc-a68d-0cdaca84c541.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><h2 id="辅助">辅助</h2><h3 id="0x01-端口转发">0x01 端口转发</h3><p>主要还是Nginx/socat 中转，如下图(来自某大佬博客)。详情待实操补充。</p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650195744938-d76e3021-a957-4ffb-98bd-388a12dd9138.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><h3 id="0x02-云函数">0x02 云函数</h3><p>略</p><h3 id="0x03-JA3-S-JARM">0x03 JA3/S/JARM</h3><p>找到篇文章：</p><p><a target="_blank" rel="noopener" href="https://www.bc-security.org/post/ja3-s-signatures-and-how-to-avoid-them/">https://www.bc-security.org/post/ja3-s-signatures-and-how-to-avoid-them/</a></p><p><a target="_blank" rel="noopener" href="https://www.vectra.ai/blogpost/c2-evasion-techniques">https://www.vectra.ai/blogpost/c2-evasion-techniques</a></p><p>好似可以通过修改 TLS 版本，能起到一定的&quot;混淆&quot;作用？</p><p>参考 java 文档 ：<a target="_blank" rel="noopener" href="https://java.com/en/configure_crypto.html">https://java.com/en/configure_crypto.html</a></p><p>禁用 TLS 选项：jdk.tls.disabledAlgorithms</p><p>编辑文件 conf/security/java.securitylib/security/java.security 添加或者删除某些tl版本</p><p>如windows上java 11 C:\Program Files\Java\jdk-11.0.13\conf\security\java.security</p><img src="https://cdn.nlark.com/yuque/0/2022/png/12849280/1650036234806-6178ba84-9d23-4a6c-9205-09248186c871.png" srcset="/img/loading.gif" lazyload referrerpolicy="no-referrer"><p><br>可以把SSLv3、TLSv1、1.1删除，或添加 TLS 1.3。又或者用高版本(11、14、16)java运行 cs服务端。</p><p>Reference</p><p><a target="_blank" rel="noopener" href="https://wbglil.gitbook.io/cobalt-strike/">https://wbglil.gitbook.io/cobalt-strike/</a><br><a target="_blank" rel="noopener" href="https://lengjibo.github.io/CobaltStrikeCode/">https://lengjibo.github.io/CobaltStrikeCode/</a><br><a target="_blank" rel="noopener" href="https://bewhale.github.io/posts/50202.html">https://bewhale.github.io/posts/50202.html</a><br><a target="_blank" rel="noopener" href="https://www.bilibili.com/read/cv14238932">https://www.bilibili.com/read/cv14238932</a><br><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/265090">https://www.anquanke.com/post/id/265090</a><br><a target="_blank" rel="noopener" href="https://hosch3n.github.io/2020/12/16/%E6%A3%80%E6%B5%8B%E4%B8%8E%E9%9A%90%E8%97%8FCobaltstrike%E6%9C%8D%E5%8A%A1%E5%99%A8/">https://hosch3n.github.io/2020/12/16/检测与隐藏Cobaltstrike服务器/</a><br><a target="_blank" rel="noopener" href="https://maka8ka.cc/post/cobaltstrike-4-3-%E7%A0%B4%E8%A7%A3-%E4%BF%AE%E5%A4%8D%E6%9A%97%E6%A1%A9/">https://maka8ka.cc/post/cobaltstrike-4-3-破解-修复暗桩/</a><br><a target="_blank" rel="noopener" href="https://ucasers.cn/%E5%AF%B9cobaltstrike4.4%E7%9A%84%E7%AE%80%E5%8D%95%E9%AD%94%E6%94%B9/">https://ucasers.cn/对cobaltstrike4.4的简单魔改/</a></p></div><hr><div><div class="post-metas my-3"></div><div class="license-box my-3"><div class="license-title"><div>修改Cobalt Strike小记</div><div>https://guosec.online/posts/324e2628.html</div></div><div class="license-meta"><div class="license-meta-item license-meta-date"><div>Posted on</div><div>April 15, 2022</div></div><div class="license-meta-item license-meta-date"><div>Updated on</div><div>September 28, 2022</div></div><div class="license-meta-item"><div>Licensed under</div><div>本博客所有文章除特别声明外，均采用 <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/"><span class="hint--top hint--rounded" aria-label="BY - Attribution"><i class="iconfont icon-by"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/"><span class="hint--top hint--rounded" aria-label="SA - Share-alike"><i class="iconfont icon-sa"></i> </span></a>&nbsp;协议，转载请注明出处！</div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/posts/3bfe19c3.html" title="关于CS在Windows7无法上线问题"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">关于CS在Windows7无法上线问题</span> <span class="visible-mobile">Previous</span></a></article><article class="post-next col-6"><a href="/posts/e3164948.html" title="向日葵&amp;钉钉RCE"><span class="hidden-mobile">向日葵&amp;钉钉RCE</span> <span class="visible-mobile">Next</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>Table of Contents</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">Search</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">Keyword</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><i class="iconfont">Copyright </i><i class="iconfont icon-copyright"></i> <i class="iconfont">2022 InfoSec</i></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">京ICP证1236666号 </a></span><span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=12345678" rel="nofollow noopener" class="beian-police" target="_blank"><span style="visibility:hidden;width:0">|</span> <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"> <span>京公网安备125364257号</span></a></span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">Blog works best with JavaScript enabled</div></noscript></body></html>